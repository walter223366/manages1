<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>门派管理</title>
    <link rel="stylesheet" th:href="@{/css/index.css}">
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}">

    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/js/base64.js}"></script>
    <script th:src="@{/layui/layui.js}" charset="utf-8"></script>
    <script th:src="@{/js/index.js}" type="text/javascript"></script>
</head>
<body>
<div class="x-body">

    <!--搜索栏-->
    <div class="layui-row">
        <form class="layui-form layui-col-md12 x-so">
            <input class="layui-input" placeholder="请输入门派名称" id="query_name" type="text" autocomplete="off">
            <input class="layui-input" placeholder="门派影响力开始范围" id="query_sinfluence" type="number" autocomplete="off" onkeypress="return (/[\d]/.test(String.fromCharCode(event.keyCode)))"><span>-</span>
            <input class="layui-input" placeholder="门派影响力结束范围" id="query_einfluence" type="number" autocomplete="off" onkeypress="return (/[\d]/.test(String.fromCharCode(event.keyCode)))">
            <button class="layui-btn" id="query_schoolPage" type="button"><i class="layui-icon">&#xe615;</i>查询</button>
            <button class="layui-btn layui-btn-primary" id="query_schoolEmpty" type="button"><i class="layui-icon">&#xe640;</i>清空条件</button>
        </form>
    </div>

    <!--操作栏-->
    <xblock>
        <button class="layui-btn layui-btn-danger" id="bacthDeleteId"><i class="layui-icon">&#xe640;</i>批量删除</button>
        <button class="layui-btn layui-btn-normal" id="addInfoId"><i class="layui-icon">&#xe654;</i>新增</button>
    </xblock>


    <!--数据栏-->
    <table class="layui-table">
        <!--数据表头-->
        <thead><tr>
            <th><div class="layui-unselect header layui-form-checkbox" lay-skin="primary"><i class="layui-icon">&#xe605;</i></div></th>
            <th>ID</th>
            <th>门派名称</th>
            <th>门派影响力</th>
            <th>操作</th>
        </thead>
        <!--数据来源-->
        <tbody class="table" id="show_schoolData"></tbody>
    </table>

    <!--分页栏-->
    <div class="page" id="page_school"></div>

    <!--详情-->
    <div class="x-body" id="addInfo" aria-hidden="true" hidden></div>

</div>
<script>
    /**初始化*/
    $(function(){
        pagingQuerySchool();
    });

    /**分页查询*/
    $("#query_schoolPage").click(function () {
        pagingQuerySchool();
    });
    function pagingQuerySchool(){
        $("#show_schoolData").empty();
        var name = $("#query_name").val();
        var sinfluence = $("#query_sinfluence").val();
        var einfluence = $("#query_einfluence").val();
        $.ajax({
            type:"POST",
            url:"/school/pagingQuery",
            data: JSON.stringify({
                "name":name,
                "sinfluence":sinfluence,
                "einfluence":einfluence
            }),
            dataType:"JSON",
            contentType:"application/json",
            success:function(data){
                if(data.code == "0" && data.result == "SECCESS"){
                    var rows = $.base64.atob(data.rows,"utf-8");
                    if(isJSON(rows)){
                        obj = JSON.parse(rows);
                        pagingPluginSchool(obj,name,sinfluence,einfluence);
                    }
                }else{
                    layer.msg(data.msg);
                }
            }
        });
    }
    function pagingPluginSchool(obj,name,sinfluence,einfluence){
        layui.use('laypage', function(){
            var laypage = layui.laypage;
            laypage.render({
                elem: 'page_school'
                ,count: obj.total
                ,layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip']
                ,theme: '#15c142'
                ,jump:function (obj) {
                    $("#show_schoolData").empty();
                    $.ajax({
                        type:"POST",
                        url:"/school/pagingQuery",
                        data: JSON.stringify({
                            "name":name,
                            "sinfluence":sinfluence,
                            "einfluence":einfluence,
                            "pageNum":obj.curr,
                            "pageSize":obj.limit
                        }),
                        dataType:"JSON",
                        contentType:"application/json",
                        success:function(data){
                            if(data.code == "0" && data.result == "SECCESS"){
                                var rows = $.base64.atob(data.rows,"utf-8");
                                if(isJSON(rows)){
                                    obj = JSON.parse(rows);
                                    showSchoolData(obj);
                                }
                            }else{
                                layer.msg(data.msg);
                            }
                        },
                        error:function () {
                            layer.alert("数据加载超时，请求重试！");
                        }
                    })
                }
            });
        });
    }
    function showSchoolData(obj){
        var total = obj.total;
        var data = "";
        if(total == 0){
            data = "<tr><td colspan='5' style='text-align:center;'>未查询到数据</td></tr>";
        }else {
            $.each(obj.datas,function (i,n) {
                data = data+"<tr>";
                data = data+"<td><div class='layui-unselect layui-form-checkbox' obj='"+$.base64.btoa(JSON.stringify(n),'utf-8')+"' lay-skin='primary' data-id='2'><i class='layui-icon'>&#xe605;</i></div></td>";
                data = data+"<td>"+(i+1)+"</td>";
                data = data+"<td>"+(isNull(n.name))+"</td>";
                data = data+"<td>"+(isNull(n.influence))+"</td>";
                data = data+"<td class='td-manage'>";
                data = data+"<a title='详情' obj='"+$.base64.btoa(JSON.stringify(n),'utf-8')+"' href='javascript:void(0);' class='layui-btn layui-btn-sm school_details'><i class='layui-icon'>&#xe615;</i>详情</a>";
                data = data+"<a title='编辑' obj='"+$.base64.btoa(JSON.stringify(n),'utf-8')+"' href='javascript:void(0);' class='layui-btn layui-btn-sm layui-btn-warm school_edit'><i class='layui-icon'>&#xe642;</i>编辑</a>";
                data = data+"<a title='删除' obj='"+$.base64.btoa(JSON.stringify(n),'utf-8')+"' href='javascript:void(0);' class='layui-btn layui-btn-sm layui-btn-danger school_delete'><i class='layui-icon'>&#xe640;</i>删除</a>";
                data = data+"</td></tr>";
            });
        }
        $("#show_schoolData").html(data);
    }
    $("#query_schoolEmpty").click(function (){
        document.getElementById("query_name").value = '';
        document.getElementById("query_sinfluence").value = '';
        document.getElementById("query_einfluence").value = '';
    });



    /**判断json格式*/
    function isJSON(str){
        try{
            JSON.parse(str);
            return true;
        }catch (e) {
            return false;
        }
    }
    /**判断字符串*/
    function isNull(str){
        if(str == null || str == ""){
            return "-";
        }else{
            return str;
        }
    }

</script>
</body>
</html>