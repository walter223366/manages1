<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>账号管理</title>
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}">
    <link rel="stylesheet" th:href="@{/css/main.css}">

    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/js/base64.js}"></script>
    <script th:src="@{/layui/layui.js}" charset="utf-8"></script>
    <script th:src="@{/js/main.js}" type="text/javascript"></script>
</head>
<body>
<div class="x-body">
    <!--搜索栏-->
    <div class="layui-row">
        <div class="search-conditional">
            <form class="layui-form-item layui-form">
                <div class="layui-inline">
                    <label class="layui-form-label">账号名称</label>
                    <div class="layui-input-inline inputWidth" >
                        <input id="query_account" type="text" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">手机号码</label>
                    <div class="layui-input-inline inputWidth">
                        <input id="query_tellPhone" type="number" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline layui-form-item">
                    <label class="layui-form-label">来&emsp;&emsp;源</label>
                    <div class="layui-input-inline inputWidth">
                        <select id="query_source" name="querySource" class="layui-input">
                            <option value="">全选</option>
                            <option value="0">微信</option>
                            <option value="1">其他</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">开始时间</label>
                    <div class="layui-input-inline inputWidth">
                        <input id="query_startTime" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">结束时间</label>
                    <div class="layui-input-inline inputWidth">
                        <input id="query_endTime" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </form>
        </div>
        <div class="search-button">
            <div class="layui-inline">
                <button onclick="pagingQuery()" type="button" class="layui-btn"><i class="layui-icon layui-icon-search"></i>查询</button>
            </div>
            <div class="layui-inline">
                <button onclick="cleanUp()" type="button" class="layui-btn layui-btn-primary"><i class="layui-icon layui-icon-delete"></i>清空条件</button>
            </div>
        </div>
    </div>

    <!--数据栏-->
    <table class="layui-table" id="dataInfo" lay-filter="dataInfo"></table>
    <script type="text/html" id="toolbarBomb">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-danger" lay-event="bombDelete"><i class="layui-icon layui-icon-delete"></i>批量删除</button>
            <button class="layui-btn layui-btn-normal" lay-event="bombAdd"><i class="layui-icon layui-icon-add-1"></i>新增</button>
        </div>
    </script>
    <script type="text/html" id="operational">
        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="edit"><i class='layui-icon layui-icon-edit'></i>编辑</a>
        <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del"><i class='layui-icon layui-icon-delete'></i>删除</a>
    </script>

    <!--新增栏-->
    <div class="x-body" id="addInfo" aria-hidden="true" hidden>
        <form class="layui-form">
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>账号名称</label>
                <div class="layui-input-inline">
                    <input id="add_account" type="text" autocomplete="off" class="layui-input">
                </div><div class="layui-form-mid layui-word-aux"><span class="x-red">请填写6到12位账号名</span></div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>手机号码</label>
                <div class="layui-input-inline">
                    <input id="add_tellPhone" type="number" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>密&emsp;&emsp;码</label>
                <div class="layui-input-inline">
                    <input id="add_password" type="password" autocomplete="off" class="layui-input">
                </div><div class="layui-form-mid layui-word-aux"><span class="x-red">请填写6到12位密码</span></div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>确认密码</label>
                <div class="layui-input-inline">
                    <input id="add_cPassword" type="password" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>来&emsp;&emsp;源</label>
                <div class="layui-input-inline">
                    <select id="add_source" class="layui-input">
                        <option value="0">微信</option>
                        <option value="1">其他</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"></label>
                <button onclick="addRequest()" type="button" class="layui-btn">新增</button>
                <button onclick="addReset()" type="button" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </form>
    </div>

    <!--编辑栏-->
    <div class="x-body" id="editInfo" aria-hidden="true" hidden>
        <form class="layui-form">
            <div class="layui-form-item" hidden>
                <label class="layui-form-label">账号id</label>
                <div class="layui-input-inline">
                    <input id="edit_id" type="text" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>账号名称</label>
                <div class="layui-input-inline">
                    <input id="edit_account" type="text" autocomplete="off" class="layui-input">
                </div><div class="layui-form-mid layui-word-aux"><span class="x-red">请填写6到12位账号名</span></div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>手机号码</label>
                <div class="layui-input-inline">
                    <input id="edit_tellPhone" type="number" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red"></span>创建时间</label>
                <div class="layui-input-inline">
                    <input id="edit_lrrq" type="text" autocomplete="off" class="layui-input" disabled="true"></div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>来&emsp;&emsp;源</label>
                <div class="layui-input-inline">
                    <select id="edit_source" class="layui-input">
                        <option value="0">微信</option>
                        <option value="1">其他</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"></label>
                <button onclick="editRequest()" type="button" class="layui-btn">修改</button>
                <button onclick="editReset()" type="button" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </form>
    </div>
</div>


<script>
    /*查询*/
    $(function(){
        pagingQuery();
    });
    function pagingQuery(){
        $("#showInfo").empty();
        var params = {
            account:$("#query_account").val(),
            tellPhone:$("#query_tellPhone").val(),
            source:$("#query_source").val(),
            startTime:$("#query_startTime").val(),
            endTime:$("#query_endTime").val()
        };
        layui.use(['layer','table'],function (){
            var layer = layui.layer,table = layui.table;
            table.render({
                elem:'#dataInfo',
                url:'/account/pagingQuery',
                method:'POST',
                contentType:"application/json",
                toolbar:'#toolbarBomb',
                id:'#dataInfo',
                height:520,
                title:'账号管理',
                even:true,
                expandRow:true,
                skin:'row',
                where:params,
                page:true,
                limit:10,
                limits:[10, 20, 30, 40, 50],
                parseData:function (res){
                    var rows = $.base64.atob(res.rows,"utf-8");
                    if(isJSON(rows)){
                        var obj = JSON.parse(rows);
                        return {
                            "code":res.code,
                            "msg":res.msg,
                            "count":obj.total,
                            "data":obj.data
                        }
                    }
                },
                cols:[
                    [
                        {type:'checkbox',fixed:'felt'},
                        {type:'numbers',title:'序号',align:'center',fixed:'felt'},
                        {field:'account',title:'账号',sort:true},
                        {field:'tellphone',title:'手机号码',sort:true},
                        {field:'source',title:'来源'},
                        {field:'lrrq',title:'创建时间',sort:true},
                        {field:'cancellation',title:'状态'},
                        {fixed:'right',title:'操作',width:200,align:'center',toolbar:'#operational'}
                    ]
                ]
            });
            //勾选批量删除
            table.on('checkbox(dataInfo)',function(obj){
                var data = obj.data;
                table.on('toolbar(dataInfo)',function (obj){
                    if(obj.event === 'bombDelete'){
                        layer.msg(data.account)
                    }
                });
            });
            //编辑、删除
            table.on('tool(dataInfo)',function (obj){
                var data = obj.data;
                if (obj.event === 'edit'){
                    edit(data);
                }else if (obj.event === 'del'){
                    del(data);
                }
            });
            //新增
            table.on('toolbar(dataInfo)',function (obj){
                if(obj.event === 'bombAdd'){
                    add();
                }
            });

        });
    }

    /*清空条件*/
    function cleanUp(){
        $("#query_account").val('');
        $("#query_tellPhone").val('');
        $("#query_startTime").val('');
        $("#query_endTime").val('');
        $("#query_source").val("");
        layui.form.render("select");
        pagingQuery();
    }

    /*批量删除*/

    /*新增*/
    function add(){
        addReset();
        layer.open({
            type: 1,
            offset: "auto",
            id: 'layerDemo'+'auto',
            area: [900+'px', 450 +'px'],
            fix: false,
            maxmin: true,
            shadeClose: true,
            shade: 0.4,
            title: "新增",
            content: $("#addInfo"),
            yes:function() {
                $("#addInfo").hide();
            }
        });
    }
    function checkAddParams(params,cPassword){
        if(params.account===null || params.account===""){
            layer.msg("账号名称不能为空",{icon:2});
            return false;
        }else{
            if(params.account.length<6 || params.account.length>12){
                layer.msg("账号名称规定6-12个字符",{icon:2});
                return false;
            }
        }
        if(params.tellphone===null || params.tellphone===""){
            layer.msg("手机号码不能为空",{icon:2});
            return false;
        }else{
            var ver = new RegExp("^1([358][0-9]|4[579]|66|7[0135678]|9[89])[0-9]{8}$");
            if(!ver.test(params.tellphone)){
                layer.msg("手机号码格式不合法",{icon:2});
                return false;
            }
        }
        if(params.password===null || params.password===""){
            layer.msg("密码不能为空",{icon:2});
            return false;
        }else{
            if(params.password.length<6 || params.password.length>12){
                layer.msg("密码规定6-12个字符",{icon:2});
                return false;
            }
        }
        if(cPassword===null || cPassword===""){
            layer.msg("确认密码不能为空",{icon:2});
            return false;
        }else{
            if(params.password !== cPassword){
                layer.msg("两次密码不一致",{icon:2});
                return false;
            }
        }
        return true;
    }
    function addRequest(){
        var params = {
            account:$("#add_account").val(),
            tellphone:Number($("#add_tellPhone").val()),
            password:$("#add_password").val(),
            source:Number($("#add_source").val())
        };
        var cPassword = $("#add_cPassword").val();
        if(checkAddParams(params,cPassword) === false){
            return;
        }
        $.ajax({
            type:"POST",
            dataType:"JSON",
            url:"/account/inAdd",
            data:params,
            success:function (data) {
                if (data.code === "0" && data.result === "SECCESS") {
                    layer.msg(data.msg,{icon:1});
                    pagingQuery();
                }else{
                    layer.msg(data.msg,{icon:2});
                }
            }
        });
    }
    function addReset(){
        $("#add_account").val('');
        $("#add_tellPhone").val('');
        $("#add_password").val('');
        $("#add_cPassword").val('');
        $("#add_source").val(0);
    }

    /*编辑*/
    function edit(data){
        var params = {
            id:data.id,
            account:data.account
        };
        $.ajax({
            type:"POST",
            dataType:"JSON",
            url:"/account/editQuery",
            data:params,
            success:function (data) {
                if(data.code === "0" && data.result === "SECCESS") {
                    var rows = $.base64.atob(data.rows,"utf-8");
                    if(isJSON(rows)) {
                        var obj = JSON.parse(rows);
                        editOpen(obj);
                    }
                }else{
                    layer.msg(data.msg,{icon:2});
                }
            }
        });
    }
    function editOpen(obj){
        document.getElementById("edit_id").value = obj.id;
        document.getElementById("edit_account").value = obj.account;
        document.getElementById("edit_tellPhone").value = obj.tellphone;
        document.getElementById("edit_lrrq").value = obj.lrrq;
        $("#edit_source").val(String(obj.source));
        layui.form.render("select");
        layer.open({
            type: 1,
            offset: "auto",
            id: 'layerDemo'+'auto',
            area: [900+'px', 450 +'px'],
            fix: false,
            maxmin: true,
            shadeClose: true,
            shade: 0.4,
            title: "编辑",
            content: $("#editInfo"),
            yes:function() {
                $("#editInfo").hide();
            }
        });
    }
    function checkEditParams(params){
        if(params.account===null || params.account===""){
            layer.msg("账号名称不能为空",{icon:2});
            return false;
        }else{
            if(params.account.length<6 || params.account.length>12){
                layer.msg("账号名称规定6-12个字符",{icon:2});
                return false;
            }
        }
        if(params.tellphone===null || params.tellphone===""){
            layer.msg("手机号码不能为空",{icon:2});
            return false;
        }else{
            var ver = new RegExp("^1([358][0-9]|4[579]|66|7[0135678]|9[89])[0-9]{8}$");
            if(!ver.test(params.tellphone)){
                layer.msg("手机号码格式不合法",{icon:2});
                return false;
            }
        }
        return true;
    }
    function editRequest(){
        var params = {
            id:$("#edit_id").val(),
            account:$("#edit_account").val(),
            tellphone:Number($("#edit_tellPhone").val()),
            lrrq:$("#edit_lrrq").val(),
            source:Number($("#edit_source").val())
        };
        if(checkEditParams(params) === false){
            return;
        }
        $.ajax({
            type:"POST",
            dataType:"JSON",
            url:"/account/inUpdate",
            data:params,
            success:function(data){
                if(data.code === "0" && data.result === "SECCESS"){
                    layer.msg(data.msg,{icon:1});
                    pagingQuery();
                }else{
                    layer.msg(data.msg,{icon:2});
                }
            }
        });
    }
    function editReset(){
        $("#edit_account").val('');
        $("#edit_tellPhone").val('');
    }

    /*删除*/
    function del(data){
        if(data.account===null || data.account===""){
            layer.msg("账号名称不能为空",{icon:2});
            return;
        }
        $.ajax({
            type:"POST",
            dataType:"JSON",
            url:"/account/inDelete",
            data:{account:data.account},
            success: function (data) {
                if(data.code === "0" && data.result === "SECCESS") {
                    layer.msg(data.msg,{icon:1});
                    pagingQuery();
                }else{
                    layer.msg(data.msg,{icon:2});
                }
            }
        });
    }

    /*判断json格式*/
    function isJSON(str){
        try{
            JSON.parse(str);
            return true;
        }catch (e) {
            return false;
        }
    }

    /*时间控件*/
    layui.use('laydate', function(){
        var laydate = layui.laydate;
        laydate.render({
            elem: '#query_startTime'
        });
        laydate.render({
            elem: '#query_endTime'
        });
    });
</script>
</body>
</html>