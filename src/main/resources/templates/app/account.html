<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>账号管理</title>
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}">
    <link rel="stylesheet" th:href="@{/css/main.css}">

    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/js/base64.js}"></script>
    <script th:src="@{/layui/layui.js}" charset="utf-8"></script>
    <script th:src="@{/js/main.js}" type="text/javascript"></script>
</head>
<body>
<div class="x-body">

    <!--搜索栏-->
    <div class="layui-row">
        <!--搜索条件-->
        <div class="search-conditional">
            <form class="layui-form-item layui-form">
                <div class="layui-inline">
                    <label class="layui-form-label">账号名称</label>
                    <div class="layui-input-inline inputWidth" >
                        <input id="query_account" type="text" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">手机号码</label>
                    <div class="layui-input-inline inputWidth">
                        <input id="query_tellPhone" type="number" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline layui-form-item">
                    <label class="layui-form-label">来&emsp;&emsp;源</label>
                    <div class="layui-input-inline inputWidth">
                        <select id="query_source" name="querySource" class="layui-input">
                            <option value="">全选</option>
                            <option value="0">微信</option>
                            <option value="1">其他</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">开始时间</label>
                    <div class="layui-input-inline inputWidth">
                        <input id="query_startTime" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">结束时间</label>
                    <div class="layui-input-inline inputWidth">
                        <input id="query_endTime" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </form>
        </div>
        <!--搜索查询-->
        <div class="search-button">
            <div class="layui-inline">
                <button id="pagingQuery" type="button" class="layui-btn"><i class="layui-icon layui-icon-search"></i>查询</button>
            </div>
            <div class="layui-inline">
                <button id="cleanUp" type="button" class="layui-btn layui-btn-primary"><i class="layui-icon layui-icon-delete"></i>清空条件</button>
            </div>
        </div>
    </div>


    <!--操作栏-->
    <xblock>
        <div class="layui-inline">
            <button id="bomb_Delete" type="button" class="layui-btn layui-btn-danger"><i class="layui-icon layui-icon-delete"></i>批量删除</button>
        </div>
        <div class="layui-inline">
            <button id="bomb_Add" type="button" class="layui-btn layui-btn-normal" ><i class="layui-icon layui-icon-add-1"></i>新增</button>
        </div>
    </xblock>


    <!--数据栏-->
    <table class="layui-hide" id="showInfo" lay-filter="test"></table>
    <!-- <table class="layui-table">
         &lt;!&ndash;数据表头&ndash;&gt;
         <thead><tr>
             <th><div class="layui-unselect header layui-form-checkbox" lay-skin="primary"><i class="layui-icon layui-icon-ok"></i></div></th>
             <th>ID</th>
             <th>账号名称</th>
             <th>手机号码</th>
             <th>来源</th>
             <th>创建时间</th>
             <th>状态</th>
             <th>操作</th>
         </thead>
         &lt;!&ndash;数据来源&ndash;&gt;
         <tbody class="table" id="showInfo"></tbody>
     </table>-->


    <!--分页栏-->
    <div class="page" id="pageInfo"></div>


    <!--新增栏-->
    <div class="x-body" id="addInfo" aria-hidden="true" hidden>
        <form class="layui-form">
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>账号名称</label>
                <div class="layui-input-inline">
                    <input id="add_account" type="text" autocomplete="off" class="layui-input">
                </div><div class="layui-form-mid layui-word-aux"><span class="x-red">请填写6到12位账号名</span></div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>手机号码</label>
                <div class="layui-input-inline">
                    <input id="add_tellPhone" type="number" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>密&emsp;&emsp;码</label>
                <div class="layui-input-inline">
                    <input id="add_password" type="password" autocomplete="off" class="layui-input">
                </div><div class="layui-form-mid layui-word-aux"><span class="x-red">请填写6到12位密码</span></div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>确认密码</label>
                <div class="layui-input-inline">
                    <input id="add_cPassword" type="password" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>来&emsp;&emsp;源</label>
                <div class="layui-input-inline">
                    <select id="add_source" class="layui-input">
                        <option value="0">微信</option>
                        <option value="1">其他</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"></label>
                <button id="request_Add" type="button" class="layui-btn">新增</button>
                <button id="reset_Add" type="button" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </form>
    </div>


    <!--编辑栏-->
    <div class="x-body" id="editInfo" aria-hidden="true" hidden>
        <form class="layui-form">
            <div class="layui-form-item" hidden>
                <label class="layui-form-label">账号id</label>
                <div class="layui-input-inline">
                    <input id="edit_id" type="text" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>账号名称</label>
                <div class="layui-input-inline">
                    <input id="edit_account" type="text" autocomplete="off" class="layui-input">
                </div><div class="layui-form-mid layui-word-aux"><span class="x-red">请填写6到12位账号名</span></div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>手机号码</label>
                <div class="layui-input-inline">
                    <input id="edit_tellPhone" type="number" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>创建时间</label>
                <div class="layui-input-inline">
                    <input id="edit_lrrq" type="text" autocomplete="off" class="layui-input" disabled="true"></div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>来&emsp;&emsp;源</label>
                <div class="layui-input-inline">
                    <select id="edit_source" class="layui-input">
                        <option value="0">微信</option>
                        <option value="1">其他</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="x-red">*</span>状&emsp;&emsp;态</label>
                <div class="layui-input-inline">
                    <input id="edit_cancellation" type="text" autocomplete="off" class="layui-input" disabled="true">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"></label>
                <button id="request_Edit" type="button" class="layui-btn">修改</button>
                <button id="reset_Edit" type="button" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </form>
    </div>

</div>


<script>
    $(function(){
        pagingQuery();
    });




    /*查询部分*/
    $("#pagingQuery").click(function () {
        pagingQuery();
    });
    $("#cleanUp").click(function (){
        $("#query_account").val('');
        $("#query_tellPhone").val('');
        $("#query_startTime").val('');
        $("#query_endTime").val('');
        $("#query_source").val();
        pagingQuery();
    });
    layui.use('laydate', function(){
        var laydate = layui.laydate;
        laydate.render({
            elem: '#query_startTime'
        });
        laydate.render({
            elem: '#query_endTime'
        });
    })
    function queryParams() {
        var datas = {
            account: $("#query_account").val(),
            tellPhone: $("#query_tellPhone").val(),
            source: $("#query_source").val(),
            startTime: $("#query_startTime").val(),
            endTime: $("#query_endTime").val()
        };
        return datas;
    }
    function pagingQuery(){
        $("#showInfo").empty();
        var datas = queryParams();
        var url = "/account/pagingQuery";
        $.ajax({
            type:"POST",
            url:url,
            data:JSON.stringify(datas),
            dataType:"JSON",
            contentType:"application/json",
            success:function(data){
                if(data.code == "0" && data.result == "SECCESS"){
                    var rows = $.base64.atob(data.rows,"utf-8");
                    if(isJSON(rows)){
                        pagingPlugin(rows,datas,url);
                    }
                }else{
                    layer.msg(data.msg,{icon:2});
                }
            }
        });
    }
    function pagingTable(rows,datas,url) {
        var obj = JSON.parse(rows);
        layer.use();
    }
    function pagingPlugin(rows,datas,url){
        var obj = JSON.parse(rows);
        layui.use('laypage', function(){
            var laypage = layui.laypage;
            laypage.render({
                elem: 'pageInfo',
                count: obj.total,
                layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip'],
                theme: '#15c142',
                jump:function (obj) {
                    datas.pageNum = obj.curr;
                    datas.pageSize = obj.limit;
                    $("#showInfo").empty();
                    $.ajax({
                        type:"POST",
                        url:url,
                        data: JSON.stringify(datas),
                        dataType:"JSON",
                        contentType:"application/json",
                        success:function(data){
                            if(data.code == "0" && data.result == "SECCESS"){
                                var rows = $.base64.atob(data.rows,"utf-8");
                                if(isJSON(rows)){
                                    showInfo(rows);
                                }
                            }else{
                                layer.msg(data.msg,{icon: 2});
                            }
                        }
                    })
                }
            });
        });
    }
    function showInfo(rows){
        var obj = JSON.parse(rows);
        var data = "";
        if( obj.total == 0){
            data = "<tr><td colspan='8' style='text-align:center;'>未查询到数据</td></tr>";
        }else {
            $.each(obj.datas,function (i,n) {
                data = data+"<tr>";
                data = data+"<td><div class='layui-unselect layui-form-checkbox' obj='"+$.base64.btoa(JSON.stringify(n),'utf-8')+"' lay-skin='primary' data-id='2'><i class='layui-icon layui-icon-ok'></i></div></td>";
                data = data+"<td>"+(i+1)+"</td>";
                data = data+"<td>"+(isNull(n.account))+"</td>";
                data = data+"<td>"+(isNull(n.tellphone))+"</td>";
                data = data+"<td>"+(isNull(n.source))+"</td>";
                data = data+"<td>"+(isNull(n.lrrq))+"</td>";
                data = data+"<td>"+(isNull(n.cancellation))+"</td>";
                data = data+"<td class='td-manage'>";
                data = data+"<a title='编辑' obj='"+$.base64.btoa(JSON.stringify(n),'utf-8')+"' href='javascript:void(0);' class='layui-btn layui-btn-sm layui-btn-warm edit'><i class='layui-icon layui-icon-edit'></i>编辑</a>";
                data = data+"<a title='删除' obj='"+$.base64.btoa(JSON.stringify(n),'utf-8')+"' href='javascript:void(0);' class='layui-btn layui-btn-sm layui-btn-danger del'><i class='layui-icon layui-icon-delete'></i>删除</a>";
                data = data+"</td></tr>";
            });
        }
        $("#showInfo").html(data);
    }



    /*新增部分*/
    $("#bomb_Add").click(function () {
        reset_Add();
        layer.open({
            type: 1,
            offset: "auto",
            id: 'layerDemo'+'auto',
            area: [900+'px', 450 +'px'],
            fix: false,
            maxmin: true,
            shadeClose: true,
            shade: 0.4,
            title: "新增",
            content: $("#addInfo"),
            yes:function() {
                $("#addInfo").hide();
            }
        });
    });
    $("#request_Add").click(function () {
        var datas = {
            account:$("#add_account").val(),
            tellphone:Number($("#add_tellPhone").val()),
            password:$("#add_password").val(),
            source:Number($("#add_source").val())
        };
        var cpassword = $("#add_cPassword").val();
        if(checkAddParams(datas,cpassword) == false){
            return;
        }
        $.ajax({
            type: "POST",
            dataType: "JSON",
            url: "/account/accountAdd",
            data: datas,
            success: function (data) {
                if (data.code == "0" && data.result == "SECCESS") {
                    layer.msg(data.msg,{icon: 1});
                    pagingQuery();
                }else{
                    layer.msg(data.msg,{icon: 2});
                }
            }
        });
    });
    $("#reset_Add").click(function () {
        reset_Add();
    });
    function checkAddParams(datas,cpassword){
        if(datas.account==null || datas.account==""){
            layer.msg("账号名称不能为空",{icon:2});
            return false;
        }else{
            if(datas.account.length<6 || datas.account.length>12){
                layer.msg("账号名称规定6-12个字符",{icon:2});
                return false;
            }
        }
        if(datas.tellphone==null || datas.tellphone==""){
            layer.msg("手机号码不能为空",{icon:2});
            return false;
        }else{
            var tver = new RegExp("^1([358][0-9]|4[579]|66|7[0135678]|9[89])[0-9]{8}$");
            if(!tver.test(datas.tellphone)){
                layer.msg("手机号码格式不合法",{icon:2});
                return false;
            }
        }
        if(datas.password==null || datas.password==""){
            layer.msg("密码不能为空",{icon:2});
            return false;
        }else{
            if(datas.password.length<6 || datas.password.length>12){
                layer.msg("密码规定6-12个字符",{icon:2});
                return false;
            }
        }
        if(cpassword==null || cpassword==""){
            layer.msg("确认密码不能为空",{icon:2});
            return false;
        }else{
            if(datas.password != cpassword){
                layer.msg("两次密码不一致",{icon:2});
                return false;
            }
        }
        return true;
    }
    function reset_Add(){
        $("#add_account").val('');
        $("#add_tellPhone").val('');
        $("#add_password").val('');
        $("#add_cPassword").val('');
        $("#add_source").val(0);
    }



    /*编辑部分*/
    $("#showInfo").on('click','.edit',function () {
        var str = $.base64.atob($(this).attr("obj"), "utf-8");
        var obj = JSON.parse(str);
        document.getElementById("edit_id").value = toNull(obj.id);
        document.getElementById("edit_account").value = toNull(obj.account);
        document.getElementById("edit_tellPhone").value = toNull(obj.tellphone);
        document.getElementById("edit_lrrq").value = toNull(obj.lrrq);
        document.getElementById("edit_source").value = toNull(obj.source);
        document.getElementById("edit_cancellation").value = toNull(obj.cancellation);
        layer.open({
            type: 1,
            offset: "auto",
            id: 'layerDemo'+'auto',
            area: [900+'px', 450 +'px'],
            fix: false,
            maxmin: true,
            shadeClose: true,
            shade: 0.4,
            title: "编辑",
            content: $("#editInfo"),
            yes:function() {
                $("#editInfo").hide();
            }
        });
    });
    $("#request_Edit").click(function () {
        var datas = editParams();
        if(checkEditParams(datas) == false){
            return;
        }
        $.ajax({
            type:"POST",
            dataType:"JSON",
            url:"/account/accountUpdate",
            data:datas,
            success:function(data){
                if(data.code == "0" && data.result == "SECCESS"){
                    layer.msg(data.msg,{icon:1});
                    pagingQuery();
                }else{
                    layer.msg(data.msg,{icon:2});
                }
            }
        });
    });
    $("#reset_Edit").click(function () {
        $("#edit_account").val('');
        $("#edit_tellPhone").val('');
    });
    function editParams(){
        var datas = {
            id:$("#edit_id").val(),
            account:$("#edit_account").val(),
            tellphone:Number($("#edit_tellPhone").val()),
            lrrq:$("#edit_lrrq").val(),
            source:Number($("#edit_source").val()),
            cancellation:$("#edit_cancellation").val()
        };
        return datas;
    }
    function checkEditParams(datas){
        if(datas.account==null || datas.account==""){
            layer.msg("账号名称不能为空",{icon:2});
            return false;
        }else{
            if(datas.account.length<6 || datas.account.length>12){
                layer.msg("账号名称规定6-12个字符",{icon:2});
                return false;
            }
        }
        if(datas.tellphone==null || datas.tellphone==""){
            layer.msg("手机号码不能为空",{icon:2});
            return false;
        }else{
            var tver = new RegExp("^1([358][0-9]|4[579]|66|7[0135678]|9[89])[0-9]{8}$");
            if(!tver.test(datas.tellphone)){
                layer.msg("手机号码格式不合法",{icon:2});
                return false;
            }
        }
        return true;
    }



    /*删除部分*/
    $('#showInfo').on('click','.del',function () {
        var str = $.base64.atob($(this).attr("obj"), "utf-8");
        var obj = JSON.parse(str);
        $.ajax({
            type: "POST",
            dataType: "JSON",
            url: "/account/accountDelete",
            data: {account:obj.account},
            success: function (data) {
                if(data.code == "0" && data.result == "SECCESS") {
                    layer.msg(data.msg,{icon: 1});
                    pagingQuery();
                }else{
                    layer.msg(data.msg,{icon: 2});
                }
            }
        });
    });



    /*判断json格式、字符串*/
    function isJSON(str){
        try{
            JSON.parse(str);
            return true;
        }catch (e) {
            return false;
        }
    }
    function isNull(str){
        if(str == null || str == ""){
            return "-";
        }else{
            return str;
        }
    }
    function toNull(str){
        if(str == null || str == ""){
           return "";
        }
        return str;
    }

</script>
</body>
</html>